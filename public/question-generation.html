<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Question Generation - GRASP</title>
    <link rel="stylesheet" href="styles/navigation.css">
    <link rel="stylesheet" href="styles/question-generation.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>

<body>
    <div class="app-container">
        <!-- Main Content Area -->
        <main class="main-content">
            <div class="content-wrapper">
                <!-- Stepper -->
                <div class="stepper">
                    <div class="stepper__step stepper__step--active" data-step="1">
                        <div class="stepper__step-number">1</div>
                        <div class="stepper__step-label">Create Objectives</div>
                    </div>
                    <div class="stepper__step" data-step="2">
                        <div class="stepper__step-number">2</div>
                        <div class="stepper__step-label">Generate Questions</div>
                    </div>
                    <div class="stepper__step" data-step="3">
                        <div class="stepper__step-number">3</div>
                        <div class="stepper__step-label">Select Output Format</div>
                    </div>
                </div>

                <!-- Content Header -->
                <div class="content-header">
                    <h1 class="content-header__title" id="page-title">Create Objectives</h1>
                </div>

                <!-- No Materials Message (shown if course has no materials) -->
                <div id="no-materials-message" style="display: none;">
                    <div style="text-align: center; padding: 60px 20px; max-width: 600px; margin: 0 auto;">
                        <i class="fas fa-book-open" style="font-size: 64px; color: #3498db; margin-bottom: 24px;"></i>
                        <h2 style="font-size: 28px; font-weight: 600; color: #2c3e50; margin-bottom: 16px;">No Course
                            Materials Found</h2>
                        <p style="font-size: 16px; color: #7f8c8d; line-height: 1.6; margin-bottom: 32px;">
                            To generate questions, you'll need to upload course materials first.
                            Please go to the <strong>Course Materials</strong> page to upload your files, text content,
                            or URLs.
                        </p>
                        <div style="display: flex; gap: 16px; justify-content: center; flex-wrap: wrap;">
                            <a href="course-materials.html" class="btn btn--primary" style="text-decoration: none;">
                                <i class="fas fa-upload"></i> Go to Course Materials
                            </a>
                            <button type="button" class="btn btn--secondary" onclick="window.location.reload()">
                                <i class="fas fa-sync"></i> Refresh
                            </button>
                        </div>
                        <div
                            style="margin-top: 40px; padding: 20px; background: #f8f9fa; border-radius: 8px; text-align: left;">
                            <p style="font-size: 14px; color: #6b7280; margin: 0;">
                                <strong>Note:</strong> Once you've uploaded materials on the Course Materials page,
                                you can return here to generate questions. The system will use the materials you've
                                uploaded
                                for the selected course.
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Step Content -->
                <div class="step-content" id="step-content">
                    <!-- Step 1: Create Objectives -->
                    <div class="step-panel step-panel--active" data-step="1">
                        <div class="objectives-section">
                            <h1 class="objectives-section__title">Review learning objectives for every page</h1>
                            <p class="objectives-section__subtitle">Organize meta learning objectives and refine
                                granular learning objectives.</p>


                            <div id="add-objectives-container">
                                <button type="button" class="btn btn--primary" id="add-objectives-btn">
                                    <i class="fas fa-plus"></i> Add learning objectives

                                </button> <!-- Add Objectives Dropdown -->
                                <div class="add-objectives-dropdown" id="add-objectives-dropdown"
                                    style="display: none;">
                                    <div class="dropdown-search">
                                        <input type="text" id="objective-search" placeholder="Search objectives..."
                                            class="dropdown-search__input">
                                    </div>
                                    <div class="dropdown-options" id="dropdown-options">
                                        <!-- Pre-defined objectives will be listed here -->
                                    </div>
                                    <div class="dropdown-separator"></div>
                                    <div class="dropdown-custom">
                                        <button type="button" class="dropdown-custom__btn" id="create-custom-btn"
                                            onclick="window.showCustomObjectiveModalFromButton(event)">
                                            <i class="fas fa-plus"></i> Create custom objective...
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <div class="objectives-groups" id="objectives-groups">
                                <!-- Meta learning objective groups will be added here -->
                            </div>

                            <!-- Empty State -->
                            <div class="objectives-empty-state" id="objectives-empty-state" style="display: none;">
                                <i class="fas fa-lightbulb"></i>
                                <h3>No learning objectives yet</h3>
                                <p>Start by adding your first learning objective to organize your course content.</p>
                            </div>

                            <!-- Create New Learning Objective Modal -->
                            <div class="modal" id="custom-objective-modal" style="display: none;">
                                <div class="modal__content" style="max-width: 700px;">
                                    <div class="modal__header">
                                        <h3 id="custom-modal-title">Create New Learning Objective</h3>
                                        <button type="button" class="modal__close" id="custom-modal-close">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                    <div class="modal__body">
                                        <div style="margin-bottom: 20px;">
                                            <label for="custom-objective-name">Learning Objective Name:</label>
                                            <input type="text" id="custom-objective-name" class="text-input"
                                                placeholder="Enter learning objective name..."
                                                style="width: 100%; padding: 10px; margin-top: 8px;">
                                        </div>

                                        <div style="margin-bottom: 20px;">
                                            <div
                                                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                                <label style="margin: 0;">Granular Objectives:</label>
                                                <button type="button" class="btn btn--secondary btn--small"
                                                    id="add-granular-btn" style="padding: 6px 12px; font-size: 14px;">
                                                    <i class="fas fa-plus"></i> Add Granular Objective
                                                </button>
                                            </div>
                                            <div id="granular-objectives-container"
                                                style="display: flex; flex-direction: column; gap: 12px;">
                                                <!-- Granular objectives will be added here -->
                                            </div>
                                        </div>

                                        <div style="margin-bottom: 20px;">
                                            <label style="margin-bottom: 12px; display: block; font-weight: 600;">Attach Materials (Optional):</label>
                                            <div id="materials-selection-container" style="max-height: 300px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 8px; padding: 12px;">
                                                <div id="materials-loading" style="text-align: center; padding: 20px; color: #7f8c8d;">
                                                    <i class="fas fa-spinner fa-spin"></i> Loading materials...
                                                </div>
                                                <div id="materials-list" style="display: none;">
                                                    <!-- Materials will be added here -->
                                                </div>
                                                <div id="materials-empty" style="display: none; text-align: center; padding: 20px; color: #7f8c8d;">
                                                    No materials available for this course.
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="modal__footer">
                                        <button type="button" class="btn btn--secondary"
                                            id="custom-modal-cancel">Cancel</button>
                                        <button type="button" class="btn btn--primary"
                                            id="custom-modal-save">Create</button>
                                        <input type="hidden" id="custom-modal-mode" value="create">
                                        <input type="hidden" id="custom-modal-objective-id" value="">
                                    </div>
                                </div>
                            </div>

                            <!-- Delete Confirmation Modal -->
                            <div class="modal" id="delete-confirmation-modal">
                                <div class="modal__content">
                                    <div class="modal__header">
                                        <h3>Delete objective?</h3>
                                        <button type="button" class="modal__close" id="delete-modal-close">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                    <div class="modal__body">
                                        <p>This will remove the objective from this group.</p>
                                    </div>
                                    <div class="modal__footer">
                                        <button type="button" class="btn btn--secondary"
                                            id="delete-modal-cancel">Cancel</button>
                                        <button type="button" class="btn btn--danger"
                                            id="delete-modal-confirm">Delete</button>
                                    </div>
                                </div>
                            </div>

                            <!-- Granularization Modal -->
                            <div class="modal" id="granularization-modal">
                                <div class="modal__content">
                                    <div class="modal__header">
                                        <h3>Make more granular</h3>
                                        <button type="button" class="modal__close" id="granularization-modal-close">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                    <div class="modal__body">
                                        <div class="granularization-options">
                                            <div class="option-group">
                                                <label class="option-group__label">How many per selected LO?</label>
                                                <div class="radio-group">
                                                    <label class="radio-option">
                                                        <input type="radio" name="granular-count" value="2">
                                                        <span>2</span>
                                                    </label>
                                                    <label class="radio-option">
                                                        <input type="radio" name="granular-count" value="3" checked>
                                                        <span>3</span>
                                                    </label>
                                                </div>
                                            </div>
                                            <div class="option-group">
                                                <label class="option-group__label">Bloom assignment:</label>
                                                <div class="checkbox-group">
                                                    <label class="checkbox-option">
                                                        <input type="checkbox" id="use-defaults" checked>
                                                        <span>Use defaults (Identify=Remember/Understand,
                                                            Explain=Understand/Analyze, Apply=Apply)</span>
                                                    </label>
                                                    <label class="checkbox-option">
                                                        <input type="checkbox" id="choose-later">
                                                        <span>I'll choose later (creates with no chips selected)</span>
                                                    </label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="modal__footer">
                                        <button type="button" class="btn btn--secondary"
                                            id="granularization-modal-cancel">Cancel</button>
                                        <button type="button" class="btn btn--primary"
                                            id="granularization-modal-confirm">Confirm</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 2: Generate Questions -->
                    <div class="step-panel" data-step="2">
                        <div class="questions-section">
                            <!-- Page Header -->
                            <div class="content-header">
                                <div class="content-header__actions">
                                    <button type="button" class="btn btn--secondary" id="regenerate-all-btn">
                                        <i class="fas fa-sync-alt"></i>
                                        Regenerate All
                                    </button>
                                    <button type="button" class="btn btn--secondary" id="export-btn">Export</button>
                                    <button type="button" class="btn btn--primary" id="add-to-bank-btn">Add to Questions
                                        Bank</button>
                                </div>
                            </div>

                            <!-- Questions Loading Spinner -->
                            <div class="questions-loading" id="questions-loading" style="display: none;">
                                <i class="fas fa-spinner fa-spin"></i>
                                <p>Generating questions...</p>
                            </div>

                            <!-- Meta LO Groups -->
                            <div class="meta-lo-groups" id="meta-lo-groups">
                                <!-- Meta LO groups will be rendered here -->
                            </div>

                            <!-- Empty State -->
                            <div class="empty-state" id="empty-state" style="display: none;">
                                <i class="fas fa-search"></i>
                                <h3>No questions found</h3>
                                <p>Try adjusting your filters or search terms.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Step 3: Select Output Format -->
                    <div class="step-panel" data-step="3">
                        <div class="export-section">
                            <div class="export-header">
                                <h1 class="export-title">Select Output Format</h1>
                                <p class="export-subtitle">Choose how you want to export your approved questions. You
                                    can select one or multiple formats.</p>
                                <div class="selected-formats-pill">
                                    Selected formats: <span id="selected-formats-count">0</span>
                                </div>
                            </div>

                            <div class="export-options-grid">
                                <!-- Canvas Single Quiz -->
                                <div class="export-option-card" data-format="canvasSingle">
                                    <div class="export-option-card__header">
                                        <i class="fas fa-calendar-alt export-option-card__icon"></i>
                                        <input type="checkbox" id="canvas-single-checkbox"
                                            class="export-option-card__checkbox">
                                    </div>
                                    <div class="export-option-card__content">
                                        <h3 class="export-option-card__title">Canvas (single quiz)</h3>
                                        <p class="export-option-card__description">Exports all selected questions as one
                                            quiz file for Canvas LMS.</p>
                                        <div class="export-option-card__estimate">Estimated: 1 quiz</div>
                                        <hr class="export-option-card__divider">
                                        <div class="export-option-card__schedule">
                                            <div class="schedule-toggle">
                                                <input type="checkbox" id="canvas-single-release-now"
                                                    class="schedule-toggle__input">
                                                <label for="canvas-single-release-now"
                                                    class="schedule-toggle__label">Release immediately</label>
                                            </div>
                                            <div class="schedule-controls" id="canvas-single-schedule-controls">
                                                <div class="schedule-control">
                                                    <label for="canvas-single-release-date">Release date</label>
                                                    <div class="date-input-wrapper">
                                                        <input type="date" id="canvas-single-release-date"
                                                            class="date-input">
                                                        <i class="fas fa-calendar date-icon"></i>
                                                    </div>
                                                </div>
                                                <div class="schedule-control">
                                                    <label for="canvas-single-release-time">Release time
                                                        (optional)</label>
                                                    <div class="time-input-wrapper">
                                                        <input type="time" id="canvas-single-release-time"
                                                            class="time-input">
                                                        <i class="fas fa-clock time-icon"></i>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Canvas Spaced Review Quiz -->
                                <div class="export-option-card" data-format="canvasSpaced">
                                    <div class="export-option-card__header">
                                        <i class="fas fa-cog export-option-card__icon"></i>
                                        <input type="checkbox" id="canvas-spaced-checkbox"
                                            class="export-option-card__checkbox">
                                    </div>
                                    <div class="export-option-card__content">
                                        <h3 class="export-option-card__title">Canvas (spaced review quiz)</h3>
                                        <p class="export-option-card__description">Splits questions into smaller sets
                                            for spaced repetition in Canvas.</p>
                                        <div class="export-option-card__estimate">Estimated: ~3–5 quizzes</div>
                                        <hr class="export-option-card__divider">
                                        <div class="export-option-card__schedule">
                                            <div class="schedule-toggle">
                                                <input type="checkbox" id="canvas-spaced-release-now"
                                                    class="schedule-toggle__input">
                                                <label for="canvas-spaced-release-now"
                                                    class="schedule-toggle__label">Release immediately</label>
                                            </div>
                                            <div class="schedule-controls" id="canvas-spaced-schedule-controls">
                                                <div class="schedule-control">
                                                    <label for="canvas-spaced-release-date">Release date</label>
                                                    <div class="date-input-wrapper">
                                                        <input type="date" id="canvas-spaced-release-date"
                                                            class="date-input">
                                                        <i class="fas fa-calendar date-icon"></i>
                                                    </div>
                                                </div>
                                                <div class="schedule-control">
                                                    <label for="canvas-spaced-release-time">Release time
                                                        (optional)</label>
                                                    <div class="time-input-wrapper">
                                                        <input type="time" id="canvas-spaced-release-time"
                                                            class="time-input">
                                                        <i class="fas fa-clock time-icon"></i>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- H5P Individual Elements -->
                                <div class="export-option-card" data-format="h5p">
                                    <div class="export-option-card__header">
                                        <i class="fas fa-puzzle-piece export-option-card__icon"></i>
                                        <input type="checkbox" id="h5p-checkbox" class="export-option-card__checkbox">
                                    </div>
                                    <div class="export-option-card__content">
                                        <h3 class="export-option-card__title">H5P (individual elements)</h3>
                                        <p class="export-option-card__description">Exports each question as a standalone
                                            H5P interactive element.</p>
                                        <div class="export-option-card__estimate">Estimated: multiple files</div>
                                    </div>
                                </div>
                            </div>

                            <!-- Canvas Naming Convention Panel -->
                            <div class="naming-convention-panel" id="naming-convention-panel" style="display: none;">
                                <label for="naming-convention-select">Canvas naming convention</label>
                                <select id="naming-convention-select" class="naming-convention-select">
                                    <option value="course_quiz">Course – Quiz 1, 2, 3…</option>
                                    <option value="module_week_quiz" selected>Module Week – Quiz</option>
                                    <option value="topic_date">Topic – YYYY-MM-DD</option>
                                </select>
                                <div class="naming-convention-preview">
                                    Example: <span id="naming-convention-example">Week 05 – Quiz</span>
                                </div>
                            </div>

                            <!-- Save Defaults -->
                            <div class="save-defaults">
                                <label class="save-defaults__label">
                                    <input type="checkbox" id="save-as-default" class="save-defaults__checkbox">
                                    <span>Save export settings as default</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sticky Bottom Actions (Step 2 only) -->
                <div class="sticky-bottom-actions" id="sticky-bottom-actions" style="display: none;">
                    <div class="sticky-actions-left">
                        <span class="selection-count">0 questions selected</span>
                    </div>
                    <div class="sticky-actions-right">
                        <button type="button" class="btn btn--primary" id="add-selected-to-bank-btn">Add Selected to
                            Question Bank</button>
                    </div>
                </div>

                <!-- Footer Actions -->
                <div class="footer-actions">
                    <button type="button" class="btn btn--secondary" id="back-btn" disabled>Back</button>
                    <button type="button" class="btn btn--primary" id="continue-btn">Continue</button>
                </div>
            </div>
        </main>
    </div>

    <!-- Export Summary Modal -->
    <div class="export-summary-modal" id="export-summary-modal" style="display: none;">
        <div class="export-summary-modal__content">
            <div class="export-summary-modal__header">
                <h3>Export Summary</h3>
                <button type="button" class="export-summary-modal__close" id="export-summary-modal-close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="export-summary-modal__body" id="export-summary-modal-body">
                <!-- Summary content will be populated here -->
            </div>
            <div class="export-summary-modal__footer">
                <button type="button" class="btn btn--primary" id="export-summary-confirm">Close</button>
            </div>
        </div>
    </div>

    <!-- Export Dropdown Menu -->
    <div class="export-dropdown" id="export-dropdown" style="display: none;">
        <div class="export-dropdown__header">
            <h4>Export Format</h4>
            <button type="button" class="export-dropdown__close" id="export-dropdown-close">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="export-dropdown__options">
            <button type="button" class="export-option-btn" data-format="qti">
                <i class="fas fa-file-code"></i>
                <span>QTI Format</span>
                <small>Import into Canvas, Blackboard, etc.</small>
            </button>
            <button type="button" class="export-option-btn" data-format="csv">
                <i class="fas fa-file-csv"></i>
                <span>CSV Format</span>
                <small>Spreadsheet compatible</small>
            </button>
            <button type="button" class="export-option-btn" data-format="json">
                <i class="fas fa-file-code"></i>
                <span>JSON Format</span>
                <small>API integration</small>
            </button>
        </div>
    </div>

    <!-- Quiz Selection Modal -->
    <div class="modal" id="quiz-selection-modal" style="display: none;">
        <div class="modal__content" style="max-width: 600px;">
            <div class="modal__header">
                <h3>Add Questions to Quiz</h3>
                <button type="button" class="modal__close" id="quiz-modal-close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal__body">
                <div class="quiz-selection-tabs">
                    <button type="button" class="quiz-tab-btn quiz-tab-btn--active" data-tab="select">
                        Select Existing Quiz
                    </button>
                    <button type="button" class="quiz-tab-btn" data-tab="create">
                        Create New Quiz
                    </button>
                </div>

                <!-- Select Existing Quiz Tab -->
                <div class="quiz-tab-content quiz-tab-content--active" id="quiz-select-tab">
                    <div class="quiz-select-section">
                        <label for="quiz-select-dropdown" style="display: block; margin-bottom: 12px; font-weight: 500; color: #374151;">
                            Choose a quiz:
                        </label>
                        <select id="quiz-select-dropdown" class="text-input" style="width: 100%; padding: 12px; margin-bottom: 20px;">
                            <option value="">Loading quizzes...</option>
                        </select>
                        <p id="quiz-select-empty" style="display: none; color: #6c757d; font-size: 14px; margin: 20px 0;">
                            No quizzes found. Create a new quiz instead.
                        </p>
                    </div>
                </div>

                <!-- Create New Quiz Tab -->
                <div class="quiz-tab-content" id="quiz-create-tab">
                    <div class="quiz-create-section">
                        <label for="quiz-name-input" style="display: block; margin-bottom: 8px; font-weight: 500; color: #374151;">
                            Quiz Name <span style="color: #e74c3c;">*</span>
                        </label>
                        <input 
                            type="text" 
                            id="quiz-name-input" 
                            class="text-input" 
                            placeholder="Enter quiz name..."
                            style="width: 100%; padding: 12px; margin-bottom: 16px;"
                        >
                        <label for="quiz-description-input" style="display: block; margin-bottom: 8px; font-weight: 500; color: #374151;">
                            Description (optional)
                        </label>
                        <textarea 
                            id="quiz-description-input" 
                            class="text-input" 
                            placeholder="Enter quiz description..."
                            rows="3"
                            style="width: 100%; padding: 12px; margin-bottom: 20px; resize: vertical;"
                        ></textarea>
                    </div>
                </div>
            </div>
            <div class="modal__footer">
                <button type="button" class="btn btn--secondary" id="quiz-modal-cancel">Cancel</button>
                <button type="button" class="btn btn--primary" id="quiz-modal-confirm" disabled>Add to Quiz</button>
            </div>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div class="toast-container" id="toast-container"></div>

    <!-- Screen reader announcements -->
    <div class="sr-only" id="sr-announcements" aria-live="polite" aria-atomic="true"></div>

    <!-- PDF.js library for PDF parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="scripts/navigation.js"></script>
    <script src="scripts/client-rag.js"></script>
    <script src="scripts/generating-content.js"></script>
    <script src="scripts/direct-ollama-service.js"></script>
    <script src="scripts/generation-questions.js"></script>
    <script src="scripts/onboarding-check.js"></script>
    <script src="scripts/question-generation.js"></script>
</body>

</html>